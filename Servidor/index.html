<!DOCTYPE html>
<html>
  <head>
  <title>Human Terminal</title>
  </head>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <body class="w3-content" style="max-width:90%">
    <div class="w3-row">
      <div class="w3-quarter w3-dark-grey w3-container w3-center w3-padding-64 w3-padding-large"  style="height:700px">
          <div id="humanInfo" class="w3-section">
            <h1>Human verification</h1>
            <label>Name</label>
            <input id="humanNameBox" class="w3-input" style="width:100%;" type="text" required="" name="Name">
            <button id="sendNameButton" type="button" class="w3-button w3-teal w3-right">Send</button>
          </div>
          <div id="doblotList" class="w3-section" style="display: none">
            <h1>Doblot List</h1>
          </div>
          <div id="doblotMessages" class="w3-section" style="display: none">
            <h1>Doblot messages</h1>
            <button id="releaseButton" type="button" class="w3-button w3-teal w3-right">Release connection</button>
          </div>
      </div>
      <div id="videoDiv" class="w3-threequarter w3-light-grey"  style="height:700px">
        <div class="feed"><img id="video" src="" style="width: 100%; height: 700px"></div>
      </div>
    </div>
    <footer class="w3-container w3-white w3-padding-16">
      <p>Doblot Proyect. Maria Fernandez, Eduardo Sevillano and Daniel Uribe</p>
    </footer>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var doblotListDiv = document.getElementById('doblotList');

      var doblotMessagesDiv = document.getElementById('doblotMessages');

      var humanInfoDiv = document.getElementById('humanInfo');
      var sendNameButton = document.getElementById('sendNameButton');
      var humanNameBox = document.getElementById('humanNameBox');

      var releaseButton = document.getElementById('releaseButton');

      var humanMessage = document.getElementById('humanMessageBox');

      var testStarter = false;

      var video = document.getElementById('video');

      var socket = io();

      //Recepcion de lista de doblots disponible
      socket.on('doblotList', function(data) {
        //se oculta el boton de release connection
        doblotListDiv.style.display = "inline-block";
        humanInfoDiv.style.display = "none";
        doblotMessagesDiv.style.display = "none";
        //Cada nombre se introduce en una etiqueta <p></p>, se le asigna un listener que envia el nombre al servidor
        //y se a√±ade al div de la lista.
        for (var i=0; i<data.length ; i++) {
          var doblotListElement = document.createElement("p");
          doblotListElement.innerHTML = data[i];

          doblotListElement.onclick = function() {
            socket.emit('doblotSelected', doblotListElement.innerHTML);
          }

          doblotListDiv.appendChild(doblotListElement);
        }
      });

      socket.on('doblotMessage', function(data) {
        if (data.type == 'connectionTest') {
          if (testStarter) {
            //Responder al servidor que OK
            socket.emit('controlMessage', {
              type: 'connectionOK',
              content: ''
            });
            testStarter = false;
          }
          else {
            //Responder al doblot con el mismo mensaje
            socket.emit('humanMessage', {
              type: 'connectionTest',
              content: ''
            });
          }
        }
        else if (data.type == 'image') {
          video.src = 'data:image/jpeg;base64,' + data.content;
        }
        else {
          doblotMessages.innerHTML = doblotMessages.innerHTML + '</br>' + data;
        }
      });

      socket.on('controlMessage', function(data) {
        if (data.type == 'connectionTest') {
          testStarter = true;
          socket.emit('humanMessage', {
            type: 'connectionTest',
            content: ''
          });
        }
        else if (data.type == 'connectionEstablished') {
          //comenzar a enviar datos o poner listener para teclas o algo asi.
          socket.emit("humanMessage", {
            type: 'videoStreamRequest',
            content: ''
          });
          
          doblotListDiv.style.display = "none";
          doblotMessagesDiv.style.display = "inline-block";
        }
        else {
          console.log('Server message: ' + data.type + ' | ' + data.content);
        }
      });

      socket.on('image', function (data) {
              video.src = "data:image/jpeg;base64," + data;
            });

      socket.on('doblotDisconnected', function(data) {
        //parar de enviar datos y algun alert para avisar de que se ha desconectado
      });


      /////////////////////////////////////////////////////

      sendNameButton.onclick = function() {
        socket.emit('humanInfo', {
          name: humanNameBox.value
        });
      };

      releaseButton.onclick = function() {
        socket.emit('releaseConnection', {});
        setTimeout(function() {
          video.src="http://www.fotogramas.es/var/ezflow_site/storage/images/noticias-cine/annabelle-2-primera-imagen-trailer/115138377-1-esl-ES/Annabelle-2-Primera-imagen-y-anuncio-del-trailer_landscape.jpg";
        }, 100);
        
      }

      </script>
  </body>
</html>
